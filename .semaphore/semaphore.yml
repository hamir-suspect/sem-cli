# This is a Semaphore configuration file demonstrating promotions
# For more information about Semaphore configuration visit:
# https://docs.semaphoreci.com/reference/pipeline-yaml-reference/

version: v1.0  # Semaphore configuration version
name: "ðŸŽ­ Promotion Pipeline"  # Pipeline display name

# Define the machine type and OS image
agent:
  machine:
    type: s1-testy
    os_image: ubuntu2004

# Configure when to stop the pipeline early
fail_fast:
  stop:
    when: branch != 'main'  # Stop all blocks if a job fails on non-main branches
auto_cancel:
  running:
    when: branch != 'main'  # Cancel running pipelines on non-main branches
  queued:
    when: branch = 'main'   # Cancel queued pipelines on main branch

# Pipeline blocks represent groups of jobs that can run in parallel
blocks:
  # Block for testing
  - name: "ðŸ§ª Test"
    task:
      jobs:
        - name: "ðŸŸ¢ Run Tests"
          commands:
            - echo "Running test suite..."
            - echo "Tests completed successfully!"

  # Block for staging build
  - name: "ðŸ“¦ Build Staging"
    dependencies: ["ðŸ§ª Test"]
    task:
      jobs:
        - name: "ðŸ”¨ Build for Staging"
          commands:
            - echo "Building staging artifacts..."
            - echo "Build completed successfully!"

promotions:
  # Promotion to staging environment
  - name: "ðŸš€ Deploy to Staging"
    pipeline_file: "promotions/staging.yml"
    auto_promote:
      when: "branch = 'main' AND result = 'passed'"

  # Promotion to production environment (requires manual approval)
  - name: "ðŸŒŸ Deploy to Production"
    pipeline_file: "promotions/production.yml"
    auto_promote: false  # Requires manual approval
